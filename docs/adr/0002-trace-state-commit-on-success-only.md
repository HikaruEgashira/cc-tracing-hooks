# ADR-0002: trace の状態コミットは送信成功時のみ行う

## ステータス
採用

## コンテキスト
`trace` 送信で `emit_turn` が失敗した場合でも `offset` を進めると、次回実行で同じ入力を再読込できず観測データが欠落する。

## 決定
`trace` の state (`offset`, `buffer`, `turn_count`) は、対象バッチの送信が成功した場合のみ前進させる。  
失敗時は state を送信前スナップショットへ戻し、同じ入力を再試行可能にする。

## 影響
- 失敗時は at-least-once になる（重複は起こりうる）。
- at-most-once よりもデータ欠落回避を優先する。
